
trigger:
  branches:
    include:
      - main

stages:

- stage: Terraform
  displayName: 'Provision Infrastructure'
  jobs:
  - job: Terraform_Apply
    displayName: 'Terraform Apply'
    pool:
      name: 'self-hosted-pool-azure'
    steps:

    # Download the SSH public key from secure files
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'id_ed25519.pub'

    # Read the SSH key content and export as pipeline variable
    - script: |
        echo "Reading SSH public key into pipeline variable"
        SSH_PUBLIC_KEY=$(cat $(download_ssh_key.secureFilePath))
        echo "##vso[task.setvariable variable=SSH_PUBLIC_KEY]$SSH_PUBLIC_KEY"
      displayName: 'Read SSH Public Key'

    # Terraform Init / Plan / Apply
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'my-service-principal'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          echo "##[group]Terraform Init/Plan/Apply"
          terraform init -input=false
          terraform plan -input=false -var "ssh_public_key=$(SSH_PUBLIC_KEY)"
          terraform apply -input=false -auto-approve -var "ssh_public_key=$(SSH_PUBLIC_KEY)"
          echo "##[endgroup]"
